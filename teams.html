<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KickoffManager — Takım Atama (Katılım Filtresi: Katılmıyorum Gizli)</title>
  <style>
    :root{--bg:#0b1220;--panel:#121a2b;--muted:#b7c4df;--ink:#e6ebf3;--line:#1f2a44;--ok:#3ddc97;--bad:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);line-height:1.45}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;flex-wrap:wrap;justify-content:space-between;gap:14px;align-items:center;margin-bottom:10px}
    h1{font-size:24px;margin:0}
    .meta{color:var(--muted);font-size:13px}
    .help{color:var(--muted);font-size:13px;margin:6px 0 16px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px;font-size:18px}
    .toolbar{display:flex;gap:10px;align-items:center;margin:4px 0 12px;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:10px;color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:1fr 1.3fr;gap:10px;align-items:center;margin:8px 0}
    .row label{font-size:14px;color:var(--muted)}
    select,button{background:#0f172a;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    select{width:100%}
    .disabled label{opacity:.6}
    .status{margin-top:8px;font-size:13px}
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--bad)}
    .footer{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:16px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    /* === Saha (görsel arka plan) === */
    .stadium{margin-top:18px}
    .pitch{position:relative; width:100%; aspect-ratio: 3 / 2; /* futbolsahasi.jpg ~612x408 */ 
           background: #0a7a32 url('futbolsahasi.jpg') center/cover no-repeat;
           border:2px solid #e6ebf3; border-radius:12px; overflow:hidden}
    .pitch-inner{position:absolute; top:0; bottom:0; left:1.5cm; right:1cm;} /* soldan/sağdan 1 cm içe */

    /* Oyuncu baloncukları */
    .marker{position:absolute; padding:6px 8px; border-radius:999px; font-size:12px; line-height:1.2;
            border:1px solid var(--line); background:#0f172a; color:#fff;
            white-space:normal; word-break:break-word; hyphens:auto; pointer-events:none}
    /* Transformlar aynen kalsın */
    .marker.teamA{transform:translate(-100%, -50%); text-align:right; background:#173a8c}
    .marker.teamB{transform:translate(0, -50%);      text-align:left;  background:#8c1b17}
    .marker .small{opacity:.85; font-size:11px}
    .legend{display:flex; gap:10px; align-items:center; margin:8px 0; color:var(--muted); font-size:13px}
    .legend .dot{width:10px; height:10px; border-radius:50%}
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>🧩 Takım Atama</h1>
    <div class="meta">
      <span>Oyuncu: <strong id="playerCount">0</strong></span>
      <span class="badge">Hafta: <span id="weekKey">—</span></span>
      <span class="badge">Maç günü: <span id="matchDate">—</span></span>
      <span class="badge">Filtre: “Katılmıyorum” verenler gizli</span>
      <button id="refresh" class="btn">↻ Katılım & tarihi oku</button>
    </div>
  </header>

  <section class="grid" id="teams"></section>

  <div class="pitch" id="pitch"><div class="pitch-inner" id="pitchInner"></div></div>

  <p class="note">Not: Bu sayfada, bu hafta <strong>Katılmıyorum</strong> seçen oyuncular seçim listelerinde görünmez. (Zaten atanmışlarsa seçim korunur.)</p>

  <div class="footer">
    <button id="saveBtn" class="btn">💾 Kaydet</button>
    <button id="clearBtn" class="btn">♻️ Temizle</button>
  </div>
</div>

<script>
(function(){
  const TEAM_KEYS=["A","B"];
  const BASE=[{key:"gk",label:"Kaleci"},{key:"lb",label:"Sol Bek"},{key:"cb",label:"Libero"},{key:"rb",label:"Sağ Bek"},{key:"lw",label:"Sol Açık"},{key:"rw",label:"Sağ Açık"}];
  const VAR=[{key:"cm1",label:"Orta Saha 1",role:"OS"},{key:"cm2",label:"Orta Saha 2",role:"OS"},{key:"st1",label:"Forvet 1",role:"FW"},{key:"st2",label:"Forvet 2",role:"FW"}];
  const coll=new Intl.Collator('tr-TR',{sensitivity:'base'});

  const state={players:[],teams:{},weekKey:'',attendance:{responses:{}}};

  // Week key (same logic as attendance.html / teams)
  function wk(){
    const d=new Date(),y=d.getFullYear(),j=new Date(y,0,1);
    return `${y}-W${String(Math.ceil((((d-j)/86400000)+j.getDay()+1)/7)).padStart(2,'0')}`;
  }

  function loadPlayers(){
    try{
      const r=localStorage.getItem('players');
      if(!r) return [];
      return JSON.parse(r).filter(p=>p&&p.name).map((p,i)=>({id:p.id??String(i+1), name:String(p.name).trim()}));
    }catch{return [];}
  }

  function defTeam(){ const s={};[...BASE,...VAR].forEach(p=>s[p.key]=null); return {formation:'2OS1FW',slots:s,bench:[],customPos:{}}; }
  function loadTeams(){
    const k='teams:'+state.weekKey;
    try{
      const raw=localStorage.getItem(k);
      if(raw){
        const o=JSON.parse(raw);
        TEAM_KEYS.forEach(t=>{o[t]=o[t]||defTeam();o[t].bench=o[t].bench||[];o[t].customPos=o[t].customPos||{}});
        return o;
      }
    }catch{}
    const o={}; TEAM_KEYS.forEach(t=>o[t]=defTeam()); return o;
  }
  const saveTeams=()=>localStorage.setItem('teams:'+state.weekKey, JSON.stringify(state.teams));

  function readAttendance(){
    try{
      const raw = localStorage.getItem('attendance:'+state.weekKey);
      const obj = raw ? JSON.parse(raw) : {responses:{}};
      state.attendance = {responses: obj.responses || {}};
    }catch{ state.attendance = {responses:{}}; }
  }
  function readMatchDate(){
    const md = localStorage.getItem('matchDate:'+state.weekKey) || '';
    document.getElementById('matchDate').textContent = prettyDate(md);
  }
  function prettyDate(ymd){ if(!ymd) return '—'; const [y,m,d]=String(ymd).split('-').map(Number); const dt=new Date(y||0,(m||1)-1,d||1); return dt.toLocaleDateString('tr-TR',{weekday:'short', day:'2-digit', month:'short', year:'numeric'}); }

  function enabled(team,key){ if(team.formation==='1OS2FW'&&key==='cm2') return false; if(team.formation==='2OS1FW'&&key==='st2') return false; return true; }
  function activeKeys(team){ const k=BASE.map(p=>p.key); team.formation==='2OS1FW'?k.push('cm1','cm2','st1'):k.push('cm1','st1','st2'); return k; }

  // Players eligible = NOT voted "out" (Katılmıyorum) this week OR already selected in this slot (to preserve selection).
  function isEligible(id){ return (state.attendance.responses[id] !== 'out'); }

  function collectUsed(except){
    const used=new Set();
    for(const tk of TEAM_KEYS){
      const t=state.teams[tk];
      for(const k of activeKeys(t)){
        const v=t.slots[k];
        if(!v) continue;
        if(except && except.teamKey===tk && except.posKey===k) continue;
        used.add(v);
      }
    }
    return used;
  }

  function candidatesForSelect(currentValue, except){
    const used = collectUsed(except);
    const arr = state.players.filter(p => (p.id===currentValue) || (isEligible(p.id) && !used.has(p.id)));
    arr.sort((a,b)=> coll.compare(a.name,b.name));
    return arr;
  }

  function renderUI(){
    const root=document.getElementById('teams'); root.innerHTML='';
    TEAM_KEYS.forEach(tk=>{
      const team=state.teams[tk];
      const card=document.createElement('div'); card.className='card';
      const h2=document.createElement('h2'); h2.textContent='Takım '+tk; card.appendChild(h2);

      // formasyon
      const rowF=document.createElement('div'); rowF.className='row';
      const labF=document.createElement('label'); labF.textContent='Formasyon';
      const selF=document.createElement('select');
      selF.innerHTML=`<option value="2OS1FW">2 OS + 1 FW</option><option value="1OS2FW">1 OS + 2 FW</option>`;
      selF.value=team.formation;
      selF.onchange=()=>{team.formation=selF.value; if(team.formation==='1OS2FW') team.slots.cm2=null; else team.slots.st2=null; render();};
      rowF.appendChild(labF); rowF.appendChild(selF); card.appendChild(rowF);

      // pozisyonlar
      [...BASE,...VAR].forEach(p=>{
        const en=enabled(team,p.key);
        const row=document.createElement('div'); row.className='row'+(en?'':' disabled');
        const lab=document.createElement('label'); lab.textContent=p.label+(en?'':' (pasif)');
        const sel=document.createElement('select'); sel.disabled=!en;
        const cur=team.slots[p.key];
        sel.append(new Option('— Seçiniz —',''));
        for(const opt of candidatesForSelect(cur,{teamKey:tk,posKey:p.key})){ sel.append(new Option(opt.name,opt.id)); }
        sel.value=cur||'';
        sel.onchange=()=>{ team.slots[p.key]=sel.value||null; render(); };
        row.appendChild(lab); row.appendChild(sel); card.appendChild(row);
      });

      // durum
      const st=document.createElement('div'); const v=validateTeam(team);
      st.className='status '+(v.ok?'ok':'bad'); st.textContent=v.ok?`Hazır: ${countFilled(team)}/9 oyuncu`:`Uyarı: ${v.messages.join(' • ')}`;
      card.appendChild(st);
      root.appendChild(card);
    });

    document.getElementById('playerCount').textContent = state.players.length;
    document.getElementById('weekKey').textContent = state.weekKey;
  }

  function countFilled(team){ let c=0; for(const k of activeKeys(team)) if(team.slots[k]) c++; return c; }
  function validateTeam(team){
    const msgs=[];
    if(team.formation==='2OS1FW'){const os=['cm1','cm2'].filter(k=>team.slots[k]).length; const fw=['st1'].filter(k=>team.slots[k]).length; if(os>2||fw>1) msgs.push('2 OS + 1 FW sınırı');}
    else {const os=['cm1'].filter(k=>team.slots[k]).length; const fw=['st1','st2'].filter(k=>team.slots[k]).length; if(os>1||fw>2) msgs.push('1 OS + 2 FW sınırı');}
    const total=countFilled(team); if(total!==9) msgs.push(`Toplam oyuncu ${total}/9`); return {ok:msgs.length===0,messages:msgs};
  }

  // Saha
  function coords(key,side){
    const base={gk:{x:6,y:50,abbr:'GK'},lb:{x:18,y:28,abbr:'LB'},cb:{x:18,y:50,abbr:'CB'},rb:{x:18,y:72,abbr:'RB'},cm1:{x:34,y:42,abbr:'CM1'},cm2:{x:34,y:58,abbr:'CM2'},lw:{x:46,y:28,abbr:'LW'},rw:{x:46,y:72,abbr:'RW'},st1:{x:49,y:45,abbr:'ST1'},st2:{x:49,y:55,abbr:'ST2'}}[key]||{x:48,y:50,abbr:key};
    return side==='L'?base:{x:100-base.x,y:base.y,abbr:base.abbr};
  }
  function clamp(el,x,side){const safe=1; const avail=side==='L'?Math.max(0,x-safe):Math.max(0,100-x-safe); el.style.maxWidth=Math.max(12,avail)+'%';}

  function renderPitch(){
    const host=document.getElementById('pitchInner'); host.innerHTML='';
    TEAM_KEYS.forEach(tk=>{
      const team=state.teams[tk]; const side=tk==='A'?'L':'R';
      [...BASE,...VAR].filter(p=>enabled(team,p.key)).forEach(p=>{
        const id=team.slots[p.key]; if(!id) return;
        const player=state.players.find(x=>x.id===id);
        const b=coords(p.key,side); const pos=(team.customPos&&team.customPos[p.key])?{...b,...team.customPos[p.key]}:b;
        const m=document.createElement('div'); m.className='marker team'+tk; m.dataset.pos=p.key; m.style.left=pos.x+'%'; m.style.top=pos.y+'%';
        m.innerHTML=`<span class="small">${pos.abbr||b.abbr}</span> • ${player?player.name:id}`; host.appendChild(m); clamp(m,pos.x,side);
        // drag
        let drag=null; const start=e=>{e.preventDefault();const t=('touches'in e)?e.touches[0]:e;drag={};document.addEventListener('mousemove',move);document.addEventListener('mouseup',end);document.addEventListener('touchmove',move,{passive:false});document.addEventListener('touchend',end);};
        const move=e=>{if(!drag)return; if(e.cancelable)e.preventDefault();const t=('touches'in e)?e.touches[0]:e;const r=host.getBoundingClientRect();let x=(t.clientX-r.left)/r.width*100;let y=(t.clientY-r.top)/r.height*100; y=Math.min(98,Math.max(2,y)); x=side==='L'?Math.min(49,Math.max(2,x)):Math.min(98,Math.max(51,x)); m.style.left=x+'%'; m.style.top=y+'%'; clamp(m,x,side); (state.teams[tk].customPos||(state.teams[tk].customPos={}))[p.key]={x,y};};
        const end=()=>{document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',end);document.removeEventListener('touchmove',move);document.removeEventListener('touchend',end); saveTeams();};
        m.addEventListener('mousedown',start); m.addEventListener('touchstart',start,{passive:false});
      });
    });
  }

  function refresh(){
    state.players = loadPlayers();
    state.weekKey = wk();
    state.teams   = loadTeams();
    readAttendance();
    readMatchDate();
    render();
  }

  function render(){ renderUI(); renderPitch(); }

  document.getElementById('refresh').onclick = refresh;
  document.getElementById('saveBtn').onclick = ()=>{ saveTeams(); alert('Kaydedildi'); };
  document.getElementById('clearBtn').onclick= ()=>{ if(confirm('Tüm seçimler temizlensin mi?')){ TEAM_KEYS.forEach(k=>state.teams[k]=defTeam()); saveTeams(); render(); } };

  // init
  refresh();
})();
</script>
</body>
</html>
